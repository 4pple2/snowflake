import streamlit as st
import pandas as pd
from snowflake.snowpark.context import get_active_session
import sys

session = get_active_session()

# ì¹¼ëŸ¼ëª… ë¶ˆëŸ¬ì˜¤ê¸°
def column_name():
    sql = f"""SELECT *
              FROM penta.CJ_TEST."VW_ì œí’ˆ_ì›”ë³„íŒë§¤_ì•„ì´í…œ" where 1=2 limit 1;  
               """
    created_dataframe = session.sql(sql)
    queried_data = created_dataframe.to_pandas()
   
    return queried_data.columns



# ì¹¼ëŸ¼ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
def column_data(filter_col):
    sql = f"""SELECT "{filter_col}"
              FROM penta.CJ_TEST."VW_ì œí’ˆ_ì›”ë³„íŒë§¤_ì•„ì´í…œ" group by "{filter_col}" ORDER by "{filter_col}" limit 10 ;
               """
    
    created_dataframe = session.sql(sql)
    queried_data = created_dataframe.to_pandas()
    
    return queried_data
    

# í•„í„° êµ¬í˜„
def filter_data(filter_dict):
    
    sql = f"""SELECT *
      FROM penta.CJ_TEST."VW_ì œí’ˆ_ì›”ë³„íŒë§¤_ì•„ì´í…œ"
      WHERE 1=1 
    """
  
    for key, value in filter_dict.items(): 
        
        value_str = ', '.join([f"'{k}'" for k in value])
        
        if value_str == '':
            break;
        else:
            sql += f""" and "{key}" NOT IN ({value_str})"""
    
    sql += """ LIMIT 10;"""                                             # í…Œì´ë¸” ê°œìˆ˜ ì„¤ì •

    
    created_dataframe = session.sql(sql)
    queried_data = created_dataframe.to_pandas()

    return queried_data


# ë”•ì…”ë„ˆë¦¬ì— ì¶”ê°€ í•¨ìˆ˜
def add_filter_to_dict(filter_dict, filter_name, filters):              # ë”•ì…”ë„ˆë¦¬ì— ì¶”ê°€
    filter_dict[filter_name] = filters
    
# ë©”ì¸ í•¨ìˆ˜
def main(select_filters):
    
    filter_dict = {}                                                    # ë”•ì…”ë„ˆë¦¬ ì´ˆê¸°í™”
    columns = ''                                                        # ê¶Œì—­ ìª¼ê°œê¸°ë¥¼ ìœ„í•œ ì´ˆê¸°í™”
    
    if len(select_filters) > 0:                                         # StreamlitAPIException ë°©ì§€í•˜ê¸° ìœ„í•œ ifë¬¸
        columns = st.columns(len(select_filters))
    
        
    for i, filter_col in enumerate(columns, start=0):                   # ì„¤ëª…ì„ ìœ„í•´ì„œ iê°’ì„ ì¶”ê°€í–ˆë‹¤.
        filters = filter_col.multiselect(f'{select_filters[i]} í•„í„°+{i}', column_data(select_filters[i])) # filters => ë¦¬ìŠ¤íŠ¸ë¡œ ìƒì„±
        add_filter_to_dict(filter_dict, select_filters[i], filters)
        
    data_filtered = filter_data(filter_dict)                            # st.writeí•˜ë©´ í‘œ ì¶”ì¶œ

    if len(select_rows) == 0:
        st.write(data_filtered)
    else:
        pdf1 = pd.pivot_table(data_filtered, index =select_columns,
                              columns=select_rows,
                              values = select_value)   
    
        st.write(pdf1)

    
if __name__ == "__main__":
    st.sidebar.markdown("# Main page ğŸˆ")  
    col1 , col2 = st.sidebar.columns(2)
    col3 , col4 = st.sidebar.columns(2)
    
    # ë¦¬ìŠ¤íŠ¸ë¡œ ì¶œë ¥ë¨
    select_filters = col1.multiselect('í•„í„°',column_name())               # ì„ íƒí•œ ê°’ì´ ë¦¬ìŠ¤íŠ¸ë¡œ ë§Œë“¤ì–´ì§„ë‹¤.
    select_rows = col2.multiselect('í–‰',column_name())
    select_columns = col3.multiselect('ì—´',column_name())
    select_value = col4.multiselect('ê°’',column_name())

    st.title("Snowflake Streamlit Pivot Table")
    main(select_filters)

    
